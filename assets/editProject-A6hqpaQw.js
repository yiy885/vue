import{_ as ie}from"./custom-button.vue_vue_type_style_index_0_lang-DsMf5cTO.js";import{_ as ce,u as de,n as V,h as N,p as pe,i as U,w as l,E as v,G as me,r as d,g as fe,o as _,a as t,b as S,j as I,t as q,c as x,a3 as _e,J as w,K as ge,R as ve,F as z,x as ye,l as B}from"./index-DCmF9yPo.js";import{p as F,d as T}from"./page-C3-3fc-_.js";import{b as A}from"./route-block-B_A1xBdJ.js";const he={key:0,class:"canvas",style:{"min-height":"500px",display:"flex","justify-content":"center","align-items":"center"}},Ve={class:"module-header",style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},xe=["src","autoplay"],D={__name:"editProject",setup(be){const J=fe(),k=de(),y=V(""),g=V([]),C=V(!0),R=V([]),P=V(null),E=V([]);N(()=>route.params.projectId),N(()=>k.isLoggedIn);const O={title:[{required:!0,message:"網頁標題不能為空",trigger:"blur"}]},G=[{type:"text",name:"文字模塊",content:[{field:"text",value:"",rules:["required","max:200"]},{field:"fontSize",value:16,rules:["min:12","max:48"]},{field:"color",value:"#000000",rules:["color"]},{field:"align",value:"left",rules:["enum:left,center,right"]}]},{type:"image",name:"圖片模塊",content:[{field:"url",value:"",rules:["required","url"]},{field:"alt",value:"",rules:[]}]},{type:"video",name:"影片模塊",content:[{field:"url",value:"",rules:["required","url"]},{field:"autoplay",value:!1,rules:[]},{field:"thumbnail",value:"",rules:["url"]}]},{type:"custom",name:"自訂模塊",content:[{field:"customField",value:"",rules:["required"]}]}],L=a=>{const o={};return a.forEach(f=>{o[f.field]=JSON.parse(JSON.stringify(f))}),o},W=a=>{const o=[];for(const f in a){const{value:i,rules:n}=a[f];o.push({field:f,value:i,rules:n})}return o},K=a=>{const o=JSON.parse(JSON.stringify(a));return o.id=Date.now().toString()+Math.random().toString(36).substring(2,9),o.content=L(a.content),o},H=a=>{g.value.splice(a,1),E.value.splice(a,1)},Q=a=>{const o={};for(const f in a.content){const i=a.content[f],n=[];i.rules.forEach(p=>{if(p==="required")n.push({required:!0,message:`${i.field} 為必填項`,trigger:"blur"});else if(p.startsWith("max:")){const s=parseInt(p.split(":")[1],10);n.push({validator:(m,u,c)=>{typeof u=="string"&&u.length>s||typeof u=="number"&&u>s?c(new Error(`${i.field} 超過最大值 ${s}`)):c()},trigger:"blur"})}else if(p.startsWith("min:")){const s=parseInt(p.split(":")[1],10);n.push({validator:(m,u,c)=>{typeof u=="string"&&u.length<s||typeof u=="number"&&u<s?c(new Error(`${i.field} 低於最小值 ${s}`)):c()},trigger:"blur"})}else if(p==="url")n.push({type:"url",message:`${i.field} 必須是有效的 URL`,trigger:"blur"});else if(p==="color")n.push({validator:(s,m,u)=>{m&&!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(m)?u(new Error(`${i.field} 必須是有效的顏色代碼 (例如 #RRGGBB)`)):u()},trigger:"blur"});else if(p.startsWith("enum:")){const s=p.substring(5).split(",");n.push({validator:(m,u,c)=>{u!=null&&!s.includes(String(u))?c(new Error(`${i.field} 的值必須是 ${s.join(", ")} 之一`)):c()},trigger:"change"})}}),o[`content.${f}.value`]=n}return o},X=a=>R.value.some(o=>o.moduleIndex===a),Y=(a,o)=>{v.info(`模擬上傳圖片: ${a.file.name} 到模塊 ID: ${o}`)},Z=async()=>{var a,o,f,i;R.value=[];try{if(!await P.value.validate()){v.error("請檢查網頁標題");return}const p=g.value.map(async(c,b)=>{const h=E.value[b];return h?await h.validate():!0});if((await Promise.all(p)).some(c=>!c)){v.error("請檢查模塊表單中的錯誤");return}const m=g.value.map(c=>{const{id:b,content:h,...$}=c;return{...$,content:W(h)}});await F.savePage(k.id,{title:y.value,modules:m});const u=route.params.id;console.log("Request URL:",`/pages/${u}`),await F.savePage(u,pageData),console.log("BaseURL:",F.apiAuth.defaults.baseURL),v.success("網頁已保存"),J.push(`/project/${k.id}`)}catch(n){console.error("保存網頁錯誤:",n),(o=(a=n.response)==null?void 0:a.data)!=null&&o.errors?(R.value=n.response.data.errors,n.response.data.errors.forEach(p=>{const s=p.moduleIndex!==void 0?`模塊 ${p.moduleIndex+1}`:"";v.error(`${s} ${p.field?p.field+":":""} ${p.message}`)})):v.error(((i=(f=n.response)==null?void 0:f.data)==null?void 0:i.error)||"無法保存網頁")}},ee=async()=>{var a,o,f;C.value=!0;try{const i=await F.getPageByUserId(k.id);y.value=i.data.title,g.value=i.data.modules.map(n=>({...n,id:n._id||Date.now().toString()+Math.random().toString(36).substring(2,9),content:L(n.content)})),R.value=[]}catch(i){v.error("加載網頁失敗: "+(((f=(o=(a=i.response)==null?void 0:a.data)==null?void 0:o.error)==null?void 0:f.message)||i.message)),y.value="",g.value=[]}finally{C.value=!1,await me()}};return pe(()=>{ee()}),(a,o)=>{const f=d("el-menu-item"),i=d("el-menu"),n=d("el-card"),p=d("el-aside"),s=d("el-input"),m=d("el-form-item"),u=d("el-form"),c=d("el-col"),b=d("el-row"),h=d("el-icon"),$=d("el-button"),te=d("el-color-picker"),M=d("el-option"),le=d("el-select"),oe=d("el-image"),ae=d("el-upload"),ne=d("el-checkbox"),re=d("el-empty"),se=d("el-main"),ue=d("el-container");return _(),U(ue,{style:{height:"100vh"}},{default:l(()=>[t(p,{width:"240px",style:{background:"#141414",padding:"16px"}},{default:l(()=>[t(n,{shadow:"always"},{header:l(()=>o[2]||(o[2]=[I("h3",null,"模塊工具",-1)])),default:l(()=>[t(i,null,{default:l(()=>[t(S(T),{list:G,group:"modules",clone:K,"item-key":"type",sort:!1,style:{cursor:"grab"}},{item:l(({element:e})=>[t(f,{class:"module-item"},{default:l(()=>[I("span",null,q(e.name),1)]),_:2},1024)]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{style:{padding:"16px"}},{default:l(()=>[t(n,{shadow:"always"},{header:l(()=>[t(b,{gutter:15,align:"middle"},{default:l(()=>[t(c,{span:18},{default:l(()=>[t(u,{model:{title:y.value},rules:O,ref_key:"titleFormRef",ref:P},{default:l(()=>[t(m,{prop:"title"},{default:l(()=>[t(s,{modelValue:y.value,"onUpdate:modelValue":o[0]||(o[0]=e=>y.value=e),placeholder:"輸入網頁標題",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),t(c,{span:6,style:{"text-align":"right"}},{default:l(()=>[t(ie,{type:"primary",backgroundColor:"rgba(245, 223, 77, 1)",textColor:"#000000",onClick:Z},{default:l(()=>o[3]||(o[3]=[B(" 保存網頁",-1)])),_:1,__:[3]})]),_:1})]),_:1})]),default:l(()=>[C.value?(_(),x("div",he,[t(h,{size:40,class:"is-loading"},{default:l(()=>[t(S(_e))]),_:1})])):(_(),U(S(T),{key:1,modelValue:g.value,"onUpdate:modelValue":o[1]||(o[1]=e=>g.value=e),group:"modules","item-key":"id",class:"canvas",style:{"min-height":"500px",border:"1px dashed #ccc",padding:"16px"}},{item:l(({element:e,index:j})=>[t(n,{class:ge(["module-card",{error:X(j)}]),shadow:"hover"},{default:l(()=>[t(u,{model:e,rules:Q(e),ref:r=>E.value[j]=r},{default:l(()=>[I("div",Ve,[I("h4",null,q(e.name||e.type)+" 模塊",1),t($,{type:"danger",icon:S(ve),circle:"",onClick:r=>H(j),size:"small"},null,8,["icon","onClick"])]),e.type==="text"?(_(),x(z,{key:0},[t(m,{prop:"content.text.value"},{default:l(()=>[t(s,{modelValue:e.content.text.value,"onUpdate:modelValue":r=>e.content.text.value=r,type:"textarea",rows:4,placeholder:"輸入文字內容",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(b,{gutter:10},{default:l(()=>[t(c,{span:8},{default:l(()=>[t(m,{prop:"content.fontSize.value"},{default:l(()=>[t(s,{modelValue:e.content.fontSize.value,"onUpdate:modelValue":r=>e.content.fontSize.value=r,modelModifiers:{number:!0},type:"number",placeholder:"字體大小",min:12,max:48},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),t(c,{span:8},{default:l(()=>[t(m,{prop:"content.color.value"},{default:l(()=>[t(te,{modelValue:e.content.color.value,"onUpdate:modelValue":r=>e.content.color.value=r},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),t(c,{span:8},{default:l(()=>[t(m,{prop:"content.align.value"},{default:l(()=>[t(le,{modelValue:e.content.align.value,"onUpdate:modelValue":r=>e.content.align.value=r,placeholder:"對齊方式"},{default:l(()=>[t(M,{label:"左對齊",value:"left"}),t(M,{label:"居中",value:"center"}),t(M,{label:"右對齊",value:"right"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e.content.text.value?(_(),x("p",{key:0,style:ye([{fontSize:e.content.fontSize.value+"px",color:e.content.color.value,textAlign:e.content.align.value},{"margin-top":"8px"}])},q(e.content.text.value),5)):w("",!0)],64)):e.type==="image"?(_(),x(z,{key:1},[e.content.url.value?(_(),U(oe,{key:0,src:e.content.url.value,alt:e.content.alt.value,style:{"max-width":"200px","margin-bottom":"8px"},fit:"contain"},null,8,["src","alt"])):w("",!0),t(ae,{action:"#","http-request":r=>Y(r,e.id),"show-file-list":!1,accept:"image/*",style:{"margin-bottom":"8px"}},{default:l(()=>[t($,{type:"primary"},{default:l(()=>o[4]||(o[4]=[B("上傳圖片",-1)])),_:1,__:[4]})]),_:2},1032,["http-request"]),t(m,{prop:"content.url.value"},{default:l(()=>[t(s,{modelValue:e.content.url.value,"onUpdate:modelValue":r=>e.content.url.value=r,placeholder:"圖片 URL",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(m,{prop:"content.alt.value"},{default:l(()=>[t(s,{modelValue:e.content.alt.value,"onUpdate:modelValue":r=>e.content.alt.value=r,placeholder:"圖片描述"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)],64)):e.type==="video"?(_(),x(z,{key:2},[e.content.url.value?(_(),x("video",{key:0,src:e.content.url.value,autoplay:e.content.autoplay.value,controls:"",style:{"max-width":"200px","margin-bottom":"8px"}},null,8,xe)):w("",!0),t(m,{prop:"content.url.value"},{default:l(()=>[t(s,{modelValue:e.content.url.value,"onUpdate:modelValue":r=>e.content.url.value=r,placeholder:"影片 URL",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(m,{prop:"content.thumbnail.value"},{default:l(()=>[t(s,{modelValue:e.content.thumbnail.value,"onUpdate:modelValue":r=>e.content.thumbnail.value=r,placeholder:"縮圖 URL",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(ne,{modelValue:e.content.autoplay.value,"onUpdate:modelValue":r=>e.content.autoplay.value=r},{default:l(()=>o[5]||(o[5]=[B("自動播放",-1)])),_:2,__:[5]},1032,["modelValue","onUpdate:modelValue"])],64)):e.type==="custom"?(_(),U(m,{key:3,prop:"content.customField.value"},{default:l(()=>[t(s,{modelValue:e.content.customField.value,"onUpdate:modelValue":r=>e.content.customField.value=r,placeholder:"自訂內容"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)):w("",!0)]),_:2},1032,["model","rules"])]),_:2},1032,["class"])]),footer:l(()=>[g.value.length?w("",!0):(_(),U(re,{key:0,description:"請拖放模塊到這裡"}))]),_:1},8,["modelValue"]))]),_:1})]),_:1})]),_:1})}}};typeof A=="function"&&A(D);const $e=ce(D,[["__scopeId","data-v-ba820872"]]);export{$e as default};
