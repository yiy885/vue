import{_ as ie}from"./custom-button.vue_vue_type_style_index_0_lang-B79Em365.js";import{_ as ce,u as de,n as h,h as N,p as pe,i as b,w as l,E as y,I as me,r as c,g as fe,o as _,a as t,b as k,j as S,t as E,c as V,Q as _e,s as w,O as ge,a1 as ve,F as M,y as ye,l as z}from"./index-Blk4pwDk.js";import{d as T}from"./vuedraggable.umd-B4I28nMv.js";import{p as he}from"./page-DLBQmZFu.js";import{b as P}from"./route-block-B_A1xBdJ.js";const Ve={key:0,class:"canvas",style:{"min-height":"500px",display:"flex","justify-content":"center","align-items":"center"}},xe={class:"module-header",style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},be=["src","autoplay"],O={__name:"editProject",setup(we){const A=fe(),L=de(),x=h(""),g=h([]),$=h(!0),U=h([]),j=h(null),R=h([]),D=N(()=>route.params.projectId);N(()=>L.isLoggedIn);const J={title:[{required:!0,message:"網頁標題不能為空",trigger:"blur"}]},W=[{type:"text",name:"文字模塊",content:[{field:"text",value:"",rules:["required","max:200"]},{field:"fontSize",value:16,rules:["min:12","max:48"]},{field:"color",value:"#000000",rules:["color"]},{field:"align",value:"left",rules:["enum:left,center,right"]}]},{type:"image",name:"圖片模塊",content:[{field:"url",value:"",rules:["required","url"]},{field:"alt",value:"",rules:[]}]},{type:"video",name:"影片模塊",content:[{field:"url",value:"",rules:["required","url"]},{field:"autoplay",value:!1,rules:[]},{field:"thumbnail",value:"",rules:["url"]}]},{type:"custom",name:"自訂模塊",content:[{field:"customField",value:"",rules:["required"]}]}],q=a=>{const o={};return a.forEach(f=>{o[f.field]=JSON.parse(JSON.stringify(f))}),o},G=a=>{const o=[];for(const f in a){const{value:i,rules:n}=a[f];o.push({field:f,value:i,rules:n})}return o},K=a=>{const o=JSON.parse(JSON.stringify(a));return o.id=Date.now().toString()+Math.random().toString(36).substring(2,9),o.content=q(a.content),o},Q=a=>{g.value.splice(a,1),R.value.splice(a,1)},H=a=>{const o={};for(const f in a.content){const i=a.content[f],n=[];i.rules.forEach(d=>{if(d==="required")n.push({required:!0,message:`${i.field} 為必填項`,trigger:"blur"});else if(d.startsWith("max:")){const u=parseInt(d.split(":")[1],10);n.push({validator:(m,r,p)=>{typeof r=="string"&&r.length>u||typeof r=="number"&&r>u?p(new Error(`${i.field} 超過最大值 ${u}`)):p()},trigger:"blur"})}else if(d.startsWith("min:")){const u=parseInt(d.split(":")[1],10);n.push({validator:(m,r,p)=>{typeof r=="string"&&r.length<u||typeof r=="number"&&r<u?p(new Error(`${i.field} 低於最小值 ${u}`)):p()},trigger:"blur"})}else if(d==="url")n.push({type:"url",message:`${i.field} 必須是有效的 URL`,trigger:"blur"});else if(d==="color")n.push({validator:(u,m,r)=>{m&&!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(m)?r(new Error(`${i.field} 必須是有效的顏色代碼 (例如 #RRGGBB)`)):r()},trigger:"blur"});else if(d.startsWith("enum:")){const u=d.substring(5).split(",");n.push({validator:(m,r,p)=>{r!=null&&!u.includes(String(r))?p(new Error(`${i.field} 的值必須是 ${u.join(", ")} 之一`)):p()},trigger:"change"})}}),o[`content.${f}.value`]=n}return o},X=a=>U.value.some(o=>o.moduleIndex===a),Y=(a,o)=>{y.info(`模擬上傳圖片: ${a.file.name} 到模塊 ID: ${o}`)},Z=async()=>{var a,o,f,i;U.value=[];try{if(!await j.value.validate()){y.error("請檢查網頁標題");return}const d=g.value.map(async(r,p)=>{const v=R.value[p];return v?await v.validate():!0});if((await Promise.all(d)).some(r=>!r)){y.error("請檢查模塊表單中的錯誤");return}const m=g.value.map(r=>{const{id:p,content:v,...I}=r;return{...I,content:G(v)}});y.success("網頁已保存"),A.push("/")}catch(n){console.error("保存網頁錯誤:",n),(o=(a=n.response)==null?void 0:a.data)!=null&&o.errors?(U.value=n.response.data.errors,n.response.data.errors.forEach(d=>{const u=d.moduleIndex!==void 0?`模塊 ${d.moduleIndex+1}`:"";y.error(`${u} ${d.field?d.field+":":""} ${d.message}`)})):y.error(((i=(f=n.response)==null?void 0:f.data)==null?void 0:i.error)||"無法保存網頁")}},ee=async()=>{var a,o,f;$.value=!0;try{const i=await he.getPageByTemplateId(D.id);x.value=i.data.title,g.value=i.data.modules.map(n=>({...n,id:n._id||Date.now().toString()+Math.random().toString(36).substring(2,9),content:q(n.content)})),U.value=[]}catch(i){y.error("加載網頁失敗: "+(((f=(o=(a=i.response)==null?void 0:a.data)==null?void 0:o.error)==null?void 0:f.message)||i.message)),x.value="",g.value=[]}finally{$.value=!1,await me()}};return pe(()=>{ee()}),(a,o)=>{const f=c("el-menu-item"),i=c("el-menu"),n=c("el-card"),d=c("el-aside"),u=c("el-input"),m=c("el-form-item"),r=c("el-form"),p=c("el-col"),v=c("el-row"),I=c("el-icon"),B=c("el-button"),te=c("el-color-picker"),F=c("el-option"),le=c("el-select"),oe=c("el-image"),ae=c("el-upload"),ne=c("el-checkbox"),re=c("el-empty"),se=c("el-main"),ue=c("el-container");return _(),b(ue,{style:{height:"100vh"}},{default:l(()=>[t(d,{width:"240px",style:{background:"#141414",padding:"16px"}},{default:l(()=>[t(n,{shadow:"always"},{header:l(()=>o[2]||(o[2]=[S("h3",null,"模塊工具",-1)])),default:l(()=>[t(i,null,{default:l(()=>[t(k(T),{list:W,group:"modules",clone:K,"item-key":"type",sort:!1,style:{cursor:"grab"}},{item:l(({element:e})=>[t(f,{class:"module-item"},{default:l(()=>[S("span",null,E(e.name),1)]),_:2},1024)]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{style:{padding:"16px"}},{default:l(()=>[t(n,{shadow:"always"},{header:l(()=>[t(v,{gutter:15,align:"middle"},{default:l(()=>[t(p,{span:18},{default:l(()=>[t(r,{model:{title:x.value},rules:J,ref_key:"titleFormRef",ref:j},{default:l(()=>[t(m,{prop:"title"},{default:l(()=>[t(u,{modelValue:x.value,"onUpdate:modelValue":o[0]||(o[0]=e=>x.value=e),placeholder:"輸入網頁標題",clearable:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),t(p,{span:6,style:{"text-align":"right"}},{default:l(()=>[t(ie,{type:"primary",backgroundColor:"rgba(245, 223, 77, 1)",textColor:"#000000",onClick:Z},{default:l(()=>o[3]||(o[3]=[z(" 保存網頁",-1)])),_:1,__:[3]})]),_:1})]),_:1})]),default:l(()=>[$.value?(_(),V("div",Ve,[t(I,{size:40,class:"is-loading"},{default:l(()=>[t(k(_e))]),_:1})])):(_(),b(k(T),{key:1,modelValue:g.value,"onUpdate:modelValue":o[1]||(o[1]=e=>g.value=e),group:"modules","item-key":"id",class:"canvas",style:{"min-height":"500px",border:"1px dashed #ccc",padding:"16px"}},{item:l(({element:e,index:C})=>[t(n,{class:ge(["module-card",{error:X(C)}]),shadow:"hover"},{default:l(()=>[t(r,{model:e,rules:H(e),ref:s=>R.value[C]=s},{default:l(()=>[S("div",xe,[S("h4",null,E(e.name||e.type)+" 模塊",1),t(B,{type:"danger",icon:k(ve),circle:"",onClick:s=>Q(C),size:"small"},null,8,["icon","onClick"])]),e.type==="text"?(_(),V(M,{key:0},[t(m,{prop:"content.text.value"},{default:l(()=>[t(u,{modelValue:e.content.text.value,"onUpdate:modelValue":s=>e.content.text.value=s,type:"textarea",rows:4,placeholder:"輸入文字內容",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(v,{gutter:10},{default:l(()=>[t(p,{span:8},{default:l(()=>[t(m,{prop:"content.fontSize.value"},{default:l(()=>[t(u,{modelValue:e.content.fontSize.value,"onUpdate:modelValue":s=>e.content.fontSize.value=s,modelModifiers:{number:!0},type:"number",placeholder:"字體大小",min:12,max:48},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),t(p,{span:8},{default:l(()=>[t(m,{prop:"content.color.value"},{default:l(()=>[t(te,{modelValue:e.content.color.value,"onUpdate:modelValue":s=>e.content.color.value=s},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),t(p,{span:8},{default:l(()=>[t(m,{prop:"content.align.value"},{default:l(()=>[t(le,{modelValue:e.content.align.value,"onUpdate:modelValue":s=>e.content.align.value=s,placeholder:"對齊方式"},{default:l(()=>[t(F,{label:"左對齊",value:"left"}),t(F,{label:"居中",value:"center"}),t(F,{label:"右對齊",value:"right"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e.content.text.value?(_(),V("p",{key:0,style:ye([{fontSize:e.content.fontSize.value+"px",color:e.content.color.value,textAlign:e.content.align.value},{"margin-top":"8px"}])},E(e.content.text.value),5)):w("",!0)],64)):e.type==="image"?(_(),V(M,{key:1},[e.content.url.value?(_(),b(oe,{key:0,src:e.content.url.value,alt:e.content.alt.value,style:{"max-width":"200px","margin-bottom":"8px"},fit:"contain"},null,8,["src","alt"])):w("",!0),t(ae,{action:"#","http-request":s=>Y(s,e.id),"show-file-list":!1,accept:"image/*",style:{"margin-bottom":"8px"}},{default:l(()=>[t(B,{type:"primary"},{default:l(()=>o[4]||(o[4]=[z("上傳圖片",-1)])),_:1,__:[4]})]),_:2},1032,["http-request"]),t(m,{prop:"content.url.value"},{default:l(()=>[t(u,{modelValue:e.content.url.value,"onUpdate:modelValue":s=>e.content.url.value=s,placeholder:"圖片 URL",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(m,{prop:"content.alt.value"},{default:l(()=>[t(u,{modelValue:e.content.alt.value,"onUpdate:modelValue":s=>e.content.alt.value=s,placeholder:"圖片描述"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)],64)):e.type==="video"?(_(),V(M,{key:2},[e.content.url.value?(_(),V("video",{key:0,src:e.content.url.value,autoplay:e.content.autoplay.value,controls:"",style:{"max-width":"200px","margin-bottom":"8px"}},null,8,be)):w("",!0),t(m,{prop:"content.url.value"},{default:l(()=>[t(u,{modelValue:e.content.url.value,"onUpdate:modelValue":s=>e.content.url.value=s,placeholder:"影片 URL",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(m,{prop:"content.thumbnail.value"},{default:l(()=>[t(u,{modelValue:e.content.thumbnail.value,"onUpdate:modelValue":s=>e.content.thumbnail.value=s,placeholder:"縮圖 URL",style:{"margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),t(ne,{modelValue:e.content.autoplay.value,"onUpdate:modelValue":s=>e.content.autoplay.value=s},{default:l(()=>o[5]||(o[5]=[z("自動播放",-1)])),_:2,__:[5]},1032,["modelValue","onUpdate:modelValue"])],64)):e.type==="custom"?(_(),b(m,{key:3,prop:"content.customField.value"},{default:l(()=>[t(u,{modelValue:e.content.customField.value,"onUpdate:modelValue":s=>e.content.customField.value=s,placeholder:"自訂內容"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)):w("",!0)]),_:2},1032,["model","rules"])]),_:2},1032,["class"])]),footer:l(()=>[g.value.length?w("",!0):(_(),b(re,{key:0,description:"請拖放模塊到這裡"}))]),_:1},8,["modelValue"]))]),_:1})]),_:1})]),_:1})}}};typeof P=="function"&&P(O);const Ie=ce(O,[["__scopeId","data-v-78e2a1fc"]]);export{Ie as default};
